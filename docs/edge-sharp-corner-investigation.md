# B2→E3エッジの角張り問題調査結果

調査日: 2025-10-12

## 問題

B2→E3エッジの最後の部分で角張った折れ線になっている。

## 調査内容

### パス分析結果

```
B2→E3のパス:
M 793.904 800.2
L 931.018 800.2
Q 939.018 800.2 939.018 792.2    ← カーブ1（正常）
L 939.018 646.2
Q 939.018 638.2 947.018 638.2    ← カーブ2（正常）
L 2204.564 638.2                 ← 長い水平線
L 2204.564 643.6                 ← 5.4pxの短い垂直線（角張り）
L 2249.564 643.6                 ← 45pxの水平線（角張り）
```

### 他エッジとの比較

| エッジ | 最後の3コマンド | Qコマンド数 | 状態 |
|--------|----------------|------------|------|
| B2→E3 | L, L, L | 2 | 最後が角張り |
| D5→E3 | L, Q, L | 2 | 正常 |
| A1→D1 | L, Q, L | 2 | 正常 |

## 原因

path-generator.js:166のcanApplyCurve関数の条件:

```javascript
return seg1Length > r * 2 && seg2Length > r * 2;
```

- cornerRadius = 8px
- 必要な最小長 = 8 × 2 = 16px
- 実際のセグメント長 = 5.4px

**5.4px < 16px のため、カーブ適用条件を満たしていない。**

## セグメント長の詳細

```
セグメント1: (2204.564, 638.2) → (2204.564, 643.6)
  - 垂直セグメント
  - 長さ: 5.4px

セグメント2: (2204.564, 643.6) → (2249.564, 643.6)
  - 水平セグメント
  - 長さ: 45px
```

## 根本原因

path-generator.js:79-108のbuildSegments関数が、p4からendへの移動時に短いセグメント（5.4px）を生成している。

これは、ノード配置時のY座標の微調整（needsFinalYAdjustment）により発生していると推測される。

## 影響範囲

類似のケース（最終セグメントが短い）を持つ他のエッジも同様の問題を抱えている可能性がある。

## 結論

短いセグメントを生成しないようにbuildSegments関数を改善するか、短いセグメントを統合する処理が必要。
