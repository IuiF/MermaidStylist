# セグメントベースパス生成への移行計画

## 目的

path-generator.jsの条件分岐爆発問題を解決し、長期的な保守性と拡張性を確保する。

## 現状の問題

- 条件分岐が指数的に増加（初期Y調整 × カーブ可否 × 最終Y調整）
- 新機能追加のたびに関数が倍増
- テストケースの網羅が困難
- Y調整時にカーブが無効化される（角張った線になる）

## 目標アーキテクチャ

パスを「セグメントのリスト」として表現し、統一的な処理で描画する。

```
制御点 → セグメント構築 → カーブ適用判定 → SVGパス生成
```

---

## フェーズ0: 事前準備

### タスク0.1: テスト環境の確認

- [ ] テスト実行環境の調査
  - [ ] tests/ディレクトリ構成の確認
  - [ ] テストランナーの有無確認（Jest、Mocha等）
  - [ ] ブラウザコンソールでの手動テスト方針決定

### タスク0.2: 依存関係の事前調査

- [ ] renderer.jsとの統合ポイント確認
  - [ ] createCurvedPath呼び出し箇所の特定
  - [ ] 引数（points, cornerRadius）の型確認
  - [ ] 戻り値（SVGパス文字列）の仕様確認

### タスク0.3: 既存コードの徹底分析

- [ ] path-generator.jsの完全理解
  - [ ] 全関数の入出力を文書化
  - [ ] 制御点（p1, p2, p3, p4）の意味を明確化
  - [ ] エッジケースの洗い出し

**完了時のコミット**:
```
テスト環境と依存関係の調査完了
```

---

## フェーズ1: 基盤整備

### タスク1.1: セグメントデータ構造の定義

- [ ] セグメントの型定義を作成
  - [ ] Segmentインターフェース定義（type, from, to）
  - [ ] セグメントタイプのenum定義（HORIZONTAL, VERTICAL）
  - [ ] 座標Point型の定義（x, y）

### タスク1.2: セグメントビルダーの骨組み作成

- [ ] segment-builder.jsファイルを作成
  - [ ] 基本的なファイル構造を作成
  - [ ] buildSegments関数のスケルトンを実装
  - [ ] 入力パラメータの型定義

### タスク1.3: セグメントビルダーのテストケース作成

- [ ] tests/unit/segment-builder.test.jsを作成（またはブラウザコンソールテスト）
  - [ ] シンプルな2点間パスのテスト
  - [ ] 3制御点パスのテスト
  - [ ] Y調整なしパスのテスト

**完了時のコミット**:
```
セグメント型定義とビルダー骨組みを追加
```

**ロールバック手順**:
- 問題発生時: `git revert HEAD`
- フェーズ0に戻る: `git reset --hard <フェーズ0完了時のコミットハッシュ>`

---

## フェーズ2: セグメントビルダー実装

### タスク2.1a: 基本セグメント構築（Y調整なし）

- [ ] buildSegments関数の基本実装（Y調整なしケースのみ）
  - [ ] 入力検証の追加
  - [ ] p1から垂直X位置への水平セグメント生成
  - [ ] 垂直セグメント（p2→p3）の生成
  - [ ] p3からp4への水平セグメント生成
  - [ ] p4からendへの最終水平セグメント生成
- [ ] テスト実行と動作確認
  - [ ] シンプルなパスで検証
  - [ ] validateSegmentsで連続性確認

### タスク2.1b: 初期Y調整の追加

- [ ] 初期Y調整ロジックの追加
  - [ ] hasInitialYAdjustment判定
  - [ ] 短い水平セグメントの生成
  - [ ] Y調整用垂直セグメントの生成
- [ ] テスト実行と動作確認
  - [ ] Y調整ありパスで検証

### タスク2.1c: 最終Y調整の追加

- [ ] 最終Y調整ロジックの追加
  - [ ] needsFinalYAdjustment判定
  - [ ] secondVerticalX座標の処理
  - [ ] 2本目の垂直セグメント生成
  - [ ] 最終水平セグメント生成
- [ ] テスト実行と動作確認
  - [ ] 複雑なY調整パスで検証

### タスク2.2: セグメント統合とバリデーション

- [ ] セグメントリストの検証
  - [ ] 連続性チェック（segment[i].to === segment[i+1].from）
  - [ ] 空セグメント検出（from === to）
  - [ ] デバッグ用のセグメント可視化関数
- [ ] 全パターンでの統合テスト
  - [ ] Y調整なし、初期Y調整のみ、最終Y調整のみ、両方ありの4パターン

**完了時のコミット**:
```
セグメントビルダー実装完了
```

**ロールバック手順**:
- 問題発生時: `git revert HEAD` または `git reset --hard <フェーズ1完了時のコミットハッシュ>`

---

## フェーズ3: パスレンダラー実装

### タスク3.1: セグメントレンダラーの骨組み

- [ ] segment-renderer.jsファイルを作成
  - [ ] renderSegments関数のスケルトン
  - [ ] SVGパス開始コマンド（M）の生成

### タスク3.2: 直線セグメント描画

- [ ] 直線描画ロジック実装
  - [ ] renderStraightSegment関数
  - [ ] 水平線（L x y）の生成
  - [ ] 垂直線（L x y）の生成

### タスク3.3: カーブ判定ロジック

- [ ] canApplyCurve関数の実装
  - [ ] セグメントタイプの一致チェック
  - [ ] 距離の十分性チェック（> cornerRadius * 2）
  - [ ] 方向判定（上向き/下向き、左向き/右向き）

### タスク3.4: カーブセグメント描画

- [ ] renderCurvedTransition関数の実装
  - [ ] 水平→垂直のカーブ生成
  - [ ] 垂直→水平のカーブ生成
  - [ ] 上向き/下向きの方向対応
  - [ ] Qコマンドによる2次ベジェ曲線生成

### タスク3.5: セグメントループ統合

- [ ] メインレンダリングループ実装
  - [ ] セグメント間のカーブ/直線判定
  - [ ] パス文字列の連結
  - [ ] 最終セグメントの特殊処理
- [ ] 8方向全てのカーブテスト
  - [ ] 各方向でのテストケース実行

**完了時のコミット**:
```
セグメントレンダラー実装完了
```

**ロールバック手順**:
- 問題発生時: `git reset --hard <フェーズ2完了時のコミットハッシュ>`

---

## フェーズ4: 統合と並行運用

### タスク4.1: 新旧システムの統合ポイント作成

- [ ] path-generator.jsに切り替えフラグ追加
  - [ ] USE_SEGMENT_BASED定数の追加
  - [ ] generateCurvedPath関数内で分岐
  - [ ] レガシーパス処理の保持

### タスク4.2: 新実装のエントリポイントと依存関係整理

- [ ] 依存関係の整理
  - [ ] segment-types.jsのrequire文追加
  - [ ] segment-builder.jsのrequire文追加
  - [ ] segment-renderer.jsのrequire文追加
  - [ ] 循環依存のチェック
- [ ] segment-based-path-generator.jsを作成
  - [ ] getSegmentBasedPathGenerator関数
  - [ ] 既存APIとの互換性確保
  - [ ] エラーハンドリング

### タスク4.3: シンプルケースでの動作確認

- [ ] 1:1水平エッジでテスト
  - [ ] レガシーとの出力比較
  - [ ] 視覚的な差異確認
  - [ ] パフォーマンス測定

### タスク4.4: Y調整なしケースでの動作確認

- [ ] 通常のカーブエッジでテスト
  - [ ] 初期Y調整なしケース
  - [ ] 最終Y調整なしケース
  - [ ] カーブの滑らかさ検証

### タスク4.5: Y調整ありケースでの動作確認

- [ ] B2→E3のようなエッジでテスト
  - [ ] 初期Y調整ありケース
  - [ ] 最終Y調整ありケース
  - [ ] 2本目の垂直セグメント処理
  - [ ] カーブの適用確認（重要：現在角張っている部分）

**完了時のコミット**:
```
新旧実装の統合完了・切り替えフラグ追加
```

**ロールバック手順**:
- 即座にロールバック: `window.USE_SEGMENT_BASED_PATH = false` でフラグを無効化
- コミット取り消し: `git reset --hard <フェーズ3完了時のコミットハッシュ>`

---

## フェーズ5: 全面移行

### タスク5.1: 全エッジタイプでの検証

- [ ] test-complex-ultimate.mmdで全エッジ検証
  - [ ] 通常エッジ
  - [ ] 点線エッジ
  - [ ] 長距離エッジ
  - [ ] バックエッジ

### タスク5.2: エッジケースの確認

- [ ] 特殊ケースのテスト
  - [ ] 非常に短い距離のエッジ
  - [ ] 複数のY調整が必要なエッジ
  - [ ] 極端なコーナー角度

### タスク5.3: パフォーマンステスト

- [ ] 大規模グラフでのベンチマーク
  - [ ] 100ノード、200エッジでの処理時間測定
  - [ ] レガシー実装との比較
  - [ ] メモリ使用量の確認

### タスク5.4: デグレーションチェック

- [ ] 既存テストケースの全通過確認
  - [ ] tests/fixtures/配下の全ファイル
  - [ ] 視覚的回帰テストの実施
  - [ ] スクリーンショット比較

---

## フェーズ6: レガシーコード削除

### タスク6.1: 切り替えフラグの削除

- [ ] USE_SEGMENT_BASEDフラグを削除
  - [ ] 新実装を常時使用に変更
  - [ ] 条件分岐の削除

### タスク6.2: レガシー関数の削除

- [ ] path-generator.js内の旧関数を削除
  - [ ] _generatePathWithInitialAdjustment
  - [ ] _generateNormalPath
  - [ ] _generateInitialCurvedSegment
  - [ ] _generateNormalCurvedSegment
  - [ ] _generateInitialStraightSegment
  - [ ] _generateNormalStraightSegment
  - [ ] _appendFinalSegment（旧版）

### タスク6.3: ファイル構成の整理

- [ ] 新しいファイル構成への移行
  - [ ] path-generator.jsをリネーム（legacy-path-generator.js）
  - [ ] segment-based-path-generator.jsをpath-generator.jsにリネーム
  - [ ] インポート文の更新

### タスク6.4: ドキュメント更新

- [ ] コメントとドキュメントの更新
  - [ ] アーキテクチャ図の更新
  - [ ] 関数仕様書の更新
  - [ ] コード内コメントの整理

---

## フェーズ7: 拡張性の検証

### タスク7.1: 新機能の追加テスト

- [ ] 新しいカーブタイプの追加
  - [ ] 3次ベジェ曲線のサポート追加
  - [ ] 実装の容易さを確認

### タスク7.2: 複雑なY調整パターンの追加

- [ ] 3本目、4本目の垂直セグメント対応
  - [ ] セグメント追加の容易さを確認
  - [ ] コード変更の局所性を確認

### タスク7.3: メンテナンス性の評価

- [ ] コードレビューの実施
  - [ ] 可読性の評価
  - [ ] テストカバレッジの確認
  - [ ] 技術的負債の有無確認

---

## リスク管理

### 技術的リスク

- [ ] 新実装のバグによる表示崩れ
  - 対策: 並行運用期間を十分に取る
  - 対策: フラグによる即座のロールバック機能

- [ ] パフォーマンス劣化
  - 対策: 各フェーズでベンチマーク実施
  - 対策: 最適化の余地を事前に確認

### プロジェクト管理リスク

- [ ] 実装時間の見積もり超過
  - 対策: 最小粒度でのタスク分割
  - 対策: 各フェーズ完了時に進捗確認

- [ ] 仕様の理解不足
  - 対策: 既存コードの徹底的な分析
  - 対策: テストケースでの動作確認

---

## 完了基準

- [ ] 全エッジでカーブが正しく描画される
- [ ] Y調整時も角張った線が出ない
- [ ] 既存の全テストケースが通過
- [ ] パフォーマンスがレガシー実装と同等以上
- [ ] コードの可読性と保守性が向上
- [ ] 新機能追加が容易になったことを確認

---

## 推定工数（修正版）

- フェーズ0: 1時間（テスト環境構築・依存関係調査）
- フェーズ1: 3時間（型定義・テスト作成含む）
- フェーズ2: 6時間（段階的実装・デバッグ含む）
- フェーズ3: 8時間（8方向カーブ対応・徹底テスト）
- フェーズ4: 5時間（統合・依存関係整理・動作確認）
- フェーズ5: 6時間（全パターン検証・エッジケース対応）
- フェーズ6: 3時間（安全な削除・ファイル構成整理）
- フェーズ7: 2時間（拡張性検証）
- バッファ: 2時間（予期しないバグ対応）

**合計: 36時間（約5日間）**

**内訳の根拠**:
- テスト作成と実行: 各フェーズで30%
- デバッグ時間: 各フェーズで20%
- ドキュメント作成: 全体で10%
- 予備時間: 全体で5%

---

## 次のステップ

1. このプランのレビューと承認
2. フェーズ1のタスク1.1から開始
3. 各タスク完了時にチェックマークを付ける
4. 問題発生時は即座にこのドキュメントを更新
