# リファクタリング計画ドキュメント

## このディレクトリについて

エッジ描画システムの長期的なリファクタリング計画をまとめたドキュメント群です。

---

## ドキュメント一覧

### 1. segment-based-path-generator-plan.md

**概要**: セグメントベースパス生成への移行計画の全体像

**内容**:
- 8つのフェーズに分割された実装計画（フェーズ0を追加）
- 各フェーズの詳細タスク（チェックリスト形式）
- リスク管理と完了基準
- 推定工数（合計36時間、約5日間）
- 各フェーズのコミット・ロールバック手順

**対象読者**: プロジェクトマネージャー、技術リーダー

**使い方**:
1. まずこのドキュメントを通読して全体像を把握
2. 各フェーズの開始前にタスクを確認
3. タスク完了時にチェックマークを付ける
4. 問題発生時にドキュメントを更新

---

### 2. segment-based-implementation-guide.md

**概要**: 各タスクの具体的な実装方法とサンプルコード

**内容**:
- データ構造の定義コード例
- 各関数の実装サンプル
- テストケースの例
- トラブルシューティングガイド

**対象読者**: 実装担当者

**使い方**:
1. plan.mdで現在のタスクを確認
2. このガイドで該当するセクションを参照
3. サンプルコードを基に実装
4. チェックポイントで動作確認

---

## クイックスタート

### 今すぐ実装を始める場合

```bash
# 1. plan.mdを開く
# フェーズ1のタスク1.1から開始

# 2. implementation-guide.mdを参照しながら実装
# タスク1.1のセクションを読む

# 3. ファイルを作成
touch src/runtime/rendering/connections/segment-types.js

# 4. サンプルコードをコピーして編集

# 5. plan.mdのチェックボックスを更新
# - [x] セグメントの型定義を作成
```

### 推奨の進め方

1. **準備**（30分）
   - plan.mdを通読
   - implementation-guide.mdを流し読み
   - 現在のpath-generator.jsを再度確認

2. **フェーズ1実装**（2時間）
   - タスク1.1: データ構造定義
   - タスク1.2: ビルダー骨組み
   - タスク1.3: テストケース作成

3. **フェーズ2実装**（4時間）
   - タスク2.1-2.4: セグメントビルダー実装

4. **以降のフェーズ**
   - plan.mdに従って順次実装

---

## 現在の問題のおさらい

### 問題

B2→E3などのエッジで、Y座標調整が必要な場合にカーブが描画されず、角張った折れ線になっている。

### 原因

path-generator.js:115で、Y調整時にカーブ処理を意図的にスキップしている。

```javascript
// カーブを無効化（Y調整時は直線で処理）
return `${basePath} L ${p4.x} ${p3.y} L ${p4.x} ${p4.y} ${finalHorizontal}`;
```

### なぜ応急処置ではなくリファクタリングか

現在の実装は条件分岐が爆発しており、Y調整時のカーブ対応を追加すると：
- 関数が2倍に増える
- テストケースが4倍に増える
- 将来的な機能追加がさらに困難になる

セグメントベース設計にすることで：
- 条件分岐が不要になる
- 新機能追加が容易になる
- テストが簡単になる
- コードが読みやすくなる

---

## 各フェーズの目的

### フェーズ0: 事前準備
テスト環境の確認、依存関係の調査、既存コードの徹底分析を行う。

### フェーズ1: 基盤整備
データ構造とビルダーの骨組みを作る。実装の土台を固める。

### フェーズ2: セグメントビルダー実装
制御点からセグメントリストを生成するロジックを完成させる。

### フェーズ3: パスレンダラー実装
セグメントリストからSVGパスを生成するロジックを実装。カーブ処理を含む。

### フェーズ4: 統合と並行運用
新旧実装を共存させ、フラグで切り替え可能にする。リスクを最小化。

### フェーズ5: 全面移行
全エッジタイプで新実装をテストし、品質を確認。

### フェーズ6: レガシーコード削除
旧実装を完全に削除し、コードベースをクリーンアップ。

### フェーズ7: 拡張性の検証
新機能追加の容易さを確認し、設計の妥当性を評価。

---

## 成功の指標

- [ ] 全エッジでカーブが正しく描画される
- [ ] Y調整時も滑らかな曲線になる
- [ ] 既存の全テストが通過
- [ ] パフォーマンスが同等以上
- [ ] コード行数が30%削減
- [ ] 新機能追加が従来の1/3の時間で可能

---

## 質問・問題が発生した場合

1. implementation-guide.mdのトラブルシューティングセクションを確認
2. plan.mdのリスク管理セクションを確認
3. 問題を記録し、両ドキュメントに追記
4. 必要に応じて計画を調整

---

## 更新履歴

- 2025-10-11 17:00: 初版作成
  - plan.md: 7フェーズ、全タスク定義完了
  - implementation-guide.md: フェーズ1-4のサンプルコード作成
  - README.md: 使い方とクイックスタート作成

- 2025-10-11 21:30: レビュー指摘事項の修正
  - REVIEW.md: 21個の問題を検出・記録
  - plan.md: フェーズ0追加、タスク2.1を3分割、工数を36時間に修正、コミット手順追加
  - implementation-guide.md: buildSegments関数のロジックエラー修正、カーブ方向を8方向に拡張、フォールバック処理完成
  - README.md: 工数見積もり更新、フェーズ0追加
