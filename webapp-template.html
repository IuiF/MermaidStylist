<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mermaid Tree Stylist - Web App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            background: #f5f5f5;
        }
        h1 {
            margin-bottom: 20px;
            color: #333;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }
        textarea {
            width: 100%;
            height: 400px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
            resize: vertical;
        }
        .button-group {
            margin-top: 16px;
            display: flex;
            gap: 12px;
        }
        button {
            padding: 12px 24px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .error-message {
            margin-top: 16px;
            padding: 12px;
            background: #ffebee;
            border-left: 4px solid #d32f2f;
            border-radius: 4px;
            color: #d32f2f;
            display: none;
        }
        .error-message.show {
            display: block;
        }
        .success-message {
            margin-top: 16px;
            padding: 12px;
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            border-radius: 4px;
            color: #2e7d32;
            display: none;
        }
        .success-message.show {
            display: block;
        }
        .info {
            margin-top: 20px;
            padding: 12px;
            background: #e3f2fd;
            border-radius: 4px;
            font-size: 13px;
            color: #1976d2;
        }
    </style>
</head>
<body>
    <h1>Mermaid Tree Stylist - Web App</h1>

    <div class="container">
        <label for="mermaidInput">Mermaid入力:</label>
        <textarea id="mermaidInput" placeholder="flowchart TD&#10;    A[ルート]-->B[子1]&#10;    A-->C[子2]&#10;    B-->D[孫1]"></textarea>

        <div class="button-group">
            <button id="downloadBtn">HTMLをダウンロード</button>
            <button id="clearBtn">クリア</button>
        </div>

        <div id="errorMessage" class="error-message"></div>
        <div id="successMessage" class="success-message"></div>

        <div class="info">
            <strong>使い方:</strong>
            <ul style="margin-left: 20px; margin-top: 8px;">
                <li>Mermaidの木構造を入力してください（flowchart TDまたはgraph TD形式）</li>
                <li>「HTMLをダウンロード」ボタンでインタラクティブなHTMLファイルを生成します</li>
                <li>生成されたHTMLはブラウザで開けます</li>
            </ul>
        </div>
    </div>

    <script>
${getEmbeddedCode()}

        // ジェネレーター（ブラウザ用）
        function generateHTML(nodes, connections) {
            const template = getBaseTemplate();

            let html = template.htmlStructure.doctype + '\n';
            html += template.htmlStructure.htmlOpen + '\n';
            html += template.htmlStructure.headOpen + '\n';
            html += '    ' + template.htmlStructure.title + '\n';
            html += '    <style>\n';
            html += template.css + '\n';
            html += '    </style>\n';
            html += template.htmlStructure.headClose + '\n';
            html += template.htmlStructure.bodyOpen + '\n';
            html += '    ' + template.htmlStructure.layoutControls + '\n';
            html += '    ' + template.htmlStructure.containerOpen + '\n';

            for (const node of nodes) {
                const hasChildren = connections.some(conn => conn.from === node.id);
                const collapseButton = hasChildren ? '<span class="collapse-button" onclick="toggleNodeCollapse(\'' + node.id + '\'); event.stopPropagation();">▼</span>' : '';
                const nodeOnClick = hasChildren ? ' onclick="toggleNodeCollapse(\'' + node.id + '\')"' : '';
                html += '        <div class="node" id="' + node.id + '" data-label="' + node.label + '" data-has-children="' + hasChildren + '"' + nodeOnClick + '><span class="label">' + node.label + '</span>' + collapseButton + '</div>\n';
            }

            html += '    ' + template.htmlStructure.containerClose + '\n';
            html += getJavaScriptContent(nodes, connections);
            html += template.htmlStructure.bodyClose + '\n';
            html += template.htmlStructure.htmlClose;

            return html;
        }

        function getJavaScriptContent(nodes, connections) {
            let script = '    <script>\n';
            script += '        const nodes = ' + JSON.stringify(nodes) + ';\n';
            script += '        const connections = ' + JSON.stringify(connections) + ';\n\n';
            script += '        // Import utilities\n';
            script += '        ' + getLayoutUtils() + '\n\n';
            script += '        // Import tree structure analyzer\n';
            script += '        ' + getTreeStructureAnalyzer() + '\n\n';
            script += '        // Import layouts\n';
            script += '        ' + getVerticalLayout() + '\n';
            script += '        ' + getHorizontalLayout() + '\n\n';
            script += '        // Import connection renderer\n';
            script += '        ' + getConnectionRenderer() + '\n\n';
            script += '        // Import collapse manager\n';
            script += '        ' + getCollapseManager() + '\n\n';
            script += '        // Import layout switcher\n';
            script += '        ' + getLayoutSwitcher() + '\n\n';
            script += '        // Import viewport manager\n';
            script += '        ' + getViewportManager() + '\n\n';
            script += '        // Import highlight manager\n';
            script += '        ' + getHighlightManager() + '\n\n';
            script += '        // Import context menu\n';
            script += '        ' + getContextMenu() + '\n\n';
            script += '        window.onload = function() {\n';
            script += '            collapseManager.init();\n';
            script += '            viewportManager.init();\n';
            script += '            contextMenu.init();\n\n';
            script += '            // Apply initial layout\n';
            script += '            currentNodePositions = verticalLayout(nodes, connections, calculateAllNodeWidths, analyzeTreeStructure);\n\n';
            script += '            // デバッグ：実際の要素幅と計算値を比較\n';
            script += '            setTimeout(() => {\n';
            script += '                debugActualWidths(nodes);\n';
            script += '                createCSSLines(connections, currentNodePositions);\n';
            script += '            }, 200);\n';
            script += '        };\n';
            script += '    <\/script>';
            return script;
        }

        function generateErrorHTML(errors) {
            let errorList = '';
            errors.forEach(err => {
                errorList += '            <li>' + err + '</li>\n';
            });

            let html = '<!DOCTYPE html>\n';
            html += '<html>\n';
            html += '<head>\n';
            html += '    <title>エラー - Mermaid Tree</title>\n';
            html += '    <style>\n';
            html += '        body {\n';
            html += '            font-family: Arial, sans-serif;\n';
            html += '            margin: 40px;\n';
            html += '            background-color: #f5f5f5;\n';
            html += '        }\n';
            html += '        .error-container {\n';
            html += '            max-width: 800px;\n';
            html += '            margin: 0 auto;\n';
            html += '            background: white;\n';
            html += '            padding: 30px;\n';
            html += '            border-radius: 8px;\n';
            html += '            box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n';
            html += '        }\n';
            html += '        h1 {\n';
            html += '            color: #d32f2f;\n';
            html += '            margin-top: 0;\n';
            html += '        }\n';
            html += '        .error-message {\n';
            html += '            background: #ffebee;\n';
            html += '            border-left: 4px solid #d32f2f;\n';
            html += '            padding: 15px;\n';
            html += '            margin: 20px 0;\n';
            html += '        }\n';
            html += '        ul {\n';
            html += '            margin: 10px 0;\n';
            html += '            padding-left: 20px;\n';
            html += '        }\n';
            html += '        li {\n';
            html += '            margin: 8px 0;\n';
            html += '            line-height: 1.6;\n';
            html += '        }\n';
            html += '        .info {\n';
            html += '            color: #666;\n';
            html += '            margin-top: 30px;\n';
            html += '            padding-top: 20px;\n';
            html += '            border-top: 1px solid #ddd;\n';
            html += '        }\n';
            html += '    </style>\n';
            html += '</head>\n';
            html += '<body>\n';
            html += '    <div class="error-container">\n';
            html += '        <h1>⚠ 木構造ではないため描画できません</h1>\n';
            html += '        <div class="error-message">\n';
            html += '            <strong>検出されたエラー:</strong>\n';
            html += '            <ul>\n';
            html += errorList;
            html += '            </ul>\n';
            html += '        </div>\n';
            html += '        <div class="info">\n';
            html += '            <p>このツールは木構造のMermaid図のみをサポートしています。</p>\n';
            html += '            <p>木構造の条件:</p>\n';
            html += '            <ul>\n';
            html += '                <li>各ノードは最大1つの親を持つ</li>\n';
            html += '                <li>ルートノード（親を持たないノード）が存在する</li>\n';
            html += '                <li>サイクル（循環参照）が存在しない</li>\n';
            html += '            </ul>\n';
            html += '        </div>\n';
            html += '    </div>\n';
            html += '</body>\n';
            html += '</html>';

            return html;
        }

        // UI制御
        const mermaidInput = document.getElementById('mermaidInput');
        const downloadBtn = document.getElementById('downloadBtn');
        const clearBtn = document.getElementById('clearBtn');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');

        clearBtn.addEventListener('click', () => {
            mermaidInput.value = '';
            hideMessages();
        });

        downloadBtn.addEventListener('click', () => {
            hideMessages();

            const mermaidContent = mermaidInput.value.trim();

            if (!mermaidContent) {
                showError('Mermaidコードを入力してください');
                return;
            }

            try {
                // パース
                const nodes = parseMermaidNodes(mermaidContent);
                const connections = parseMermaidConnections(mermaidContent);

                if (nodes.length === 0) {
                    showError('ノードが見つかりませんでした');
                    return;
                }

                // バリデーション
                const validation = validateTreeStructure(nodes, connections);

                let html;
                if (!validation.isValid) {
                    html = generateErrorHTML(validation.errors);
                } else {
                    html = generateHTML(nodes, connections);
                }

                // ダウンロード
                const blob = new Blob([html], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'mermaid-tree.html';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showSuccess('HTMLファイルをダウンロードしました');
            } catch (error) {
                showError('エラー: ' + error.message);
            }
        });

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.add('show');
        }

        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.classList.add('show');
        }

        function hideMessages() {
            errorMessage.classList.remove('show');
            successMessage.classList.remove('show');
        }
    </script>
</body>
</html>